# GitOps Hello World Infra Staging Brigade

Second iteration of the GitOps hello world REST API infrastructure configuration for staging, using
[Brigade](https://brigade.sh/) as the CD system.

This Brigade project listens for events generated by the [Brigade GCR Gateway](https://github.com/danillouz/brigade-gcr-gateway/), which happen when Docker images are pushed to
and removed from the [Google Container Registry](https://cloud.google.com/container-registry/).

## Creating a Brigade Project

These instructions assume Brigade is already running on a k8s cluster, see the [install guide](https://github.com/Azure/brigade/blob/master/docs/topics/install.md)
for more information.
Note that it's _recommended_ to isolate brigade in it's own namespace and _enable
RBAC_, see the [security guide](https://github.com/Azure/brigade/blob/master/docs/topics/security.md)
for more information.

First generate a `values.yaml` which holds the project config (don't commit this file):

```
$ helm repo add brigade https://azure.github.io/brigade

$ helm inspect values brigade/brigade-project > values.yaml
```

Modify at least these fields in the `values.yaml`:

```yaml
project: "crowdynews/gitops-hello-world-infra-staging-brigade"
repository: "https://github.com/crowdynews/gitops-hello-world-infra-staging-brigade"
cloneURL: "https://github.com/crowdynews/gitops-hello-world-infra-staging-brigade.git"
sharedSecret: "SOME_SECRET"
```

## Installing a Brigade Project

_It's recommended that Brigade is installed in it's own namespace, see the [Brigade Security Guide](https://github.com/Azure/brigade/blob/master/docs/topics/security.md) for more information._

```
$ helm install brigade/brigade-project --namespace brigade -n gitops-hello-world-infra-staging-brigade -f values.yaml
```

Check the status of the project by running:

```
$ helm status gitops-hello-world-infra-staging-brigade
```

A Brigade project can be updated after changing fields in `values.yaml` by running:

```
$ helm upgrade gitops-hello-world-infra-staging-brigade brigade/brigade-project -f values.yaml --namespace brigade
```

And deleted by running:

```
$ helm delete gitops-hello-world-infra-staging-brigade
```

## Using the Brigade Client

At the moment there're no prebuilt binaries for `brig`, follow the [developer guide](https://github.com/Azure/brigade/blob/master/docs/topics/developers.md)
to install `brig`.

The `brigade.js` script can be run manually with the following command:

```
$ brig run -f ./brigade.js crowdynews/gitops-hello-world-infra-staging-brigade
```

This will output something like:

```
Started build 01c8fsqq61pesmdeby48evvhj2 as "brigade-worker-01c8fsqq61pesmdeby48evvhj2"
prestart: src/brigade.js written

[brigade] brigade-worker version: 0.11.0
[brigade:k8s] Creating PVC named brigade-worker-01c8fsqq61pesmdeby48evvhj2
[brigade:app] after: default event fired
[brigade:app] beforeExit(2): destroying storage
[brigade:k8s] Destroying PVC named brigade-worker-01c8fsqq61pesmdeby48evvhj2
```

Where `brigade-worker-01c8fsqq61pesmdeby48evvhj2` is the name of the k8s pod.
